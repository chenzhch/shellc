# shellc
**脚本语言转换为C代码的工具**
### 安装
```bash
cc shellc.c -O2 -o shellc 
```
### 编译脚本并生成可执行程序
```bash
shellc sh example.sh
cc example.sh.c -O2 -o example
```
生成的C代码是 ```example.sh.c```，即原始文件名后加```.c```。
对于生产环境中使用的程序，建议在编译时添加参数```-s```或编译后用```strip```命令, 以删除可执行程序中的符号表，增加了反汇编和逆向工程的难度。

本人试用了可以将shell脚本编译成可执行程序的工具```shc```，存在的主要问题是：

```shc``` 实际调用的是```sh -c``` 命令，通过```ps -ef``` 命令就能看到源码。shell脚本长度不能超过ARG_MAX值。通过伪造解释器或内存转储等方式获取到脚本源代码（目前GITHUB上所有脚本转C代码的工具都存在此漏洞）。

shellc除了解决```shc```存在的问题外，还增加了代码混淆、随机生成有效字符位置计算函数、随机字符加密、反调试等增加反汇编逆向复杂度。
如果需要进一步增加逆向难度，还可使用```obfuscator-llvm```等专业工具对生成后的C代码进一步进行混淆。
1.0及以上版本除了支持shell外，还支持其他脚本语言，可以完全替代```shc```。1.6版增加防伪造解释器或内存转储方式获取得脚本源代码功能。防伪造解释器需启用-a或-i选项。
目前，该程序已在```AIX```、```UNIX```、 ```Linux``` 环境中具有实际应用。建议对编译后的程序进行全面测试，以防止生产故障。  

### 使用手册
- 生成C代码命令
 
   ```shellc command inputfile [-t] [-s] [-a] [-f fix-format] [-e fix-file] [-p parameter] [-b 8|16|32|64] [-i interpreter]```  

    command：   执行脚本的命令，如 ```sh```、```perl```、```python```、```node```、```ruby```、```Rscript```、```php``` 等。
                
    inputfile： 脚本语言文件名

    -t 选项：   对于不支持反调试功能的系统，生成的代码需该选项。

    -s 选项：   生成C代码模式，-s选项是使用安全模式，缺省使用通用模式。

    -a 选项：   防止伪造解释器，要求运行环境的解释器与编译环境的解释器MD5值相同。

    -f 选项：   修复参数0值或安全模式外部参数。

    -e 选项：   使用外部文件修复参数0值  

    -p 选项：   命令参数，如```busybox shell```使用```shellc busybox example.sh -p sh``` 

    -b 选项：   操作系统位数设置

    -i 选项：   内置解释器，```interpreter```是运行环境对应的解释器文件名, 如```/usr/bin/sh```, 也可使用自定义文件名, 如```/tmp/myshell```, 如果运行时环境中没有相应的解释器，则解释器文件将在运行时自动生成。内置解释器具有防伪造解释器功能。
 

- 代码模式区别

    通用模式shell脚本在大多数Linux类操作系统中存在部分代码可见问题，可通过```/proc/[pid]/fd/[pipe]```获取read命令后代码，安全模式无此问题。

    通用模式脚本长度不能大于管道缓冲区值，64位系统一般是64K；安全模式无此问题。

    通用模式支持在脚本中对信号量处理，安全模式不支持。

    通用模式支持所有脚本语言人机交互，安全模式部分语言不支持, 如```csh```、```tcsh```。

    安全模式人机交互需修改为从设备```/dev/tty```读取，如shell需将```read input``` 为 ```read input </dev/tty```，其他语言参考```test/test_input.*```程序，通用模式无须修改代码。

    安全模式与通用模式支持脚本语言类型部分不同，可通过运行```test/run.sh```检查是否支持。

- 参数修复  
       
    参数0值支持```BASH```、 ```FISH```、```ZSH```、```PERL```、```PYTHON```、```JAVASCRIPT```、```LUA```、```RUBY```修复。

    除了内置的修复类型，还可使用外部文件修复参数0。文件格式：```?```表示参数0值，换行必须明确使用```\n```，双引号需加转义符```\```。参考```test/fix.txt```。

    安全模式非可定义函数shell语言外部参数调用，需指定修复类型，如 ```FISH```、```PERL```、```PYTHON```、```JAVASCRIPT```、```LUA```、```RUBY```、```CSH```、```TCLSH```、```PHP```、```RC```。    
    

### 反调试功能
0.3及以上版本增加了反调试功能，并且测试了以下工具反调试功能
操作系统| 调试工具|是否支持
------|------|------
AIX 7.1|dbx sdb|支持
SCO UNIX 5.0.6|dbx sdb adb|支持
Red Hat Linux7.8|gdb|支持
CentOS Linux6.4|gdb|支持
debian 12.4.0|gdb|支持
Fedora 39|gdb lldb|支持
FreeBSD 14.0|gdb|支持
openSUSE Leap 15.5|gdb|支持
OracleLinux R9|gdb|支持
ubuntu 22.04.3|gdb lldb|支持
openEuler|gdb|支持
Debian|gdb|支持
NetBSD 10.0|gdb|不支持
DragonFly 6.4|gdb|不支持
macOS 13|lldb|不支持


### 修改记录
- v1.6.2 2024-09-01
  
  修复内存溢出

- v1.6.1 2024-09-01
  
  修复数组长度为空

- v1.6 2024-09-01

  增加内置解释器功能

  增加防伪造解释器功能

  增加防内存转储功能

- v1.5 2024-08-25

  修复安全模式退出值不正确问题

- v1.4 2024-08-17

  修复内存泄露

- v1.3 2024-06-28

  增加命令参数支持

- v1.2 2024-06-22

  增加操作系统位数设置功能

- v1.1 2024-06-12

  扩充安全模式下功能

- v1.02 2024-06-06

  删除生代码中的宏定义便于专业工具生成更复杂的混淆代码

- v1.01 2024-06-02

  删除对FreeBSD特殊处理

- v1.0 2024-06-01

  增加非SHELL脚本语言支持

  增加参数0修复功能

  删除BSD和LINUX变种系统线程要求

- v0.3 2023-12-25

  增加反调试功能
 
  修复在部分系统下编译告警

- v0.21 2023-12-13

  修复在```zsh```环境下程序BUG

- v0.2  2023-12-12

  数据结构由结构体改为字符串数组减少大文件编译时间

  增加代码字符加密功能

- v0.1  2023-12-01

  初始版本 